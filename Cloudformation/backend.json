{
  "Parameters": {
    "KeyPairName": {
      "Description": "The EC2 Key Pair name",
      "Type": "String"
    },
    "UserID": {
      "Description": "If you are alucloud07 this means that UserID should be 07",
      "Type": "String"
    }
  },

  "Mappings": {
    "AWSInstanceType2Arch": {
      "t3.small": { "Arch": "HVM64" }
    },

    "AWSRegionArch2AMI": {
      "us-east-1": { "HVM64": "ami-00874d747dde814fa" }
    }
  },

  "Resources": {
    "MainEC2SecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Open ports 80 and 22",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "VpcId": "vpc-83a213fb"
      }
    },

    "RDSDBInstance": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "MySQL",
        "MasterUsername": "awsuser",
        "DBInstanceClass": "db.t2.small",
        "VPCSecurityGroups": ["sg-43524731"],
        "AllocatedStorage": "20",
        "MasterUserPassword": "cloudvlc",
        "DBSnapshotIdentifier": "cursocloudaws-cellar-5-6-39-vpc",
        "DBSubnetGroupName": "db-subnet-group-default-public",
        "StorageType": "gp2",
        "PubliclyAccessible": true
      }
    },

    "BackendAutoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "VPCZoneIdentifier": [
          "subnet-2bfb6c4f",
          "subnet-c2f25afd",
          "subnet-432a9408"
        ],
        "LaunchConfigurationName": { "Ref": "BackendLaunchConfig" },
        "MinSize": "1",
        "MaxSize": "2",
        "DesiredCapacity": "1",
        "TargetGroupARNs": [{ "Ref": "BackendALBTargetGroup" }]
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT45M"
        }
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MinInstancesInService": "1",
          "MaxBatchSize": "1",
          "PauseTime": "PT15M",
          "WaitOnResourceSignals": "true"
        }
      }
    },
    "ScaleOutPolicy": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "AutoScalingGroupName": { "Ref": "BackendAutoScalingGroup" },
        "Cooldown": "120",
        "ScalingAdjustment": "1"
      }
    },

    "CPUAlarmHigh": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "EvaluationPeriods": "1",
        "Statistic": "Average",
        "Threshold": "70",
        "AlarmDescription": "Alarm if average CPU > 70% for 1 period of 60 seconds",
        "Period": "60",
        "AlarmActions": [{ "Ref": "ScaleOutPolicy" }],
        "Namespace": "AWS/EC2",
        "Dimensions": [
          {
            "Name": "AutoScalingGroupName",
            "Value": { "Ref": "BackendAutoScalingGroup" }
          }
        ],
        "ComparisonOperator": "GreaterThanThreshold",
        "MetricName": "CPUUtilization"
      }
    },

    "ScaleInPolicy": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "AutoScalingGroupName": { "Ref": "BackendAutoScalingGroup" },
        "Cooldown": "120",
        "ScalingAdjustment": "-1"
      }
    },

    "CPUAlarmLow": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "EvaluationPeriods": "2",
        "Statistic": "Average",
        "Threshold": "20",
        "AlarmDescription": "Alarm if average CPU < 20% for 2 periods of 60 seconds",
        "Period": "60",
        "AlarmActions": [{ "Ref": "ScaleInPolicy" }],
        "Namespace": "AWS/EC2",
        "Dimensions": [
          {
            "Name": "AutoScalingGroupName",
            "Value": { "Ref": "BackendAutoScalingGroup" }
          }
        ],
        "ComparisonOperator": "LessThanThreshold",
        "MetricName": "CPUUtilization"
      }
    },

    "BackendLaunchConfig": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "AssociatePublicIpAddress": "true",
        "ImageId": {
          "Fn::FindInMap": [
            "AWSRegionArch2AMI",
            { "Ref": "AWS::Region" },
            { "Fn::FindInMap": ["AWSInstanceType2Arch", "t3.small", "Arch"] }
          ]
        },
        "SecurityGroups": [{ "Ref": "MainEC2SecurityGroup" }],
        "KeyName": { "Ref": "KeyPairName" },
        "InstanceType": "t3.small"
      }
    },

    "BackendLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Subnets": ["subnet-2bfb6c4f", "subnet-c2f25afd", "subnet-432a9408"],
        "SecurityGroups": [{ "Ref": "BackendLoadBalancerSecurityGroup" }]
      }
    },

    "BackendALBListener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": { "Ref": "BackendALBTargetGroup" }
          }
        ],
        "LoadBalancerArn": { "Ref": "BackendLoadBalancer" },
        "Port": "80",
        "Protocol": "HTTP"
      }
    },

    "BackendALBTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "HealthCheckIntervalSeconds": 30,
        "HealthCheckTimeoutSeconds": 25,
        "HealthyThresholdCount": 3,
        "Port": 80,
        "Protocol": "HTTP",
        "UnhealthyThresholdCount": 5,
        "VpcId": "vpc-83a213fb"
      }
    },

    "BackendLoadBalancerSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable HTTP access on port 80",
        "VpcId": "vpc-83a213fb",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    }
  },

  "Outputs": {
    "EC2InstanceDNS": {
      "Description": "Returns the public DNS of the Load Balancer",
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            { "Fn::GetAtt": ["BackendLoadBalancer", "DNSName"] },
            "/cellar-webapp-sql"
          ]
        ]
      }
    }
  }
}
